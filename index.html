<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>US2016</title>
    <!-- JQuery -->
    <script src="layout/jquery-2.2.0.min.js"></script>
    <!-- Bootstrap -->
    <link href="layout/bootstrap-3.3.6-dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="layout/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
    <!-- leaflet -->
    <!-- <link rel="stylesheet" href="layout/leaflet-0.7.3/leaflet.css" />
    <script src="layout/leaflet-0.7.3/leaflet.js"></script> -->
    <!-- d3 and plugins -->
    <script src="layout/d3-master/d3.min.js"></script>
    <script src="layout/queue.js"></script>
    <script src="layout/topojson.js"></script>
    <script src="layout/charts.js"></script>    
    <!-- custom css -->
    <link rel="stylesheet" href="layout/css/main.css" /> 
  </head>
  <body>

  <div class="container title">
    <h1>The Will of the People<br><small>All ballots are not casted/created equal. One person, One vote? Not in the primaries...</small></h1>
  </div>

  <div class="container">
    <div class="row top-buffer">
      
      <div class="col-xs-7">
        <div id="map"></div>
      </div>

      <div class="col-xs-5">
        <div class="btn-toolbar" role="toolbar" aria-label="...">
          <div class="btn-group btn-group-sm" role="group" aria-label="...">
            <button type="button" class="btn btn-default btn-reality btn-display active" value="reality" aria-pressed="true">Reality</button>
            <button type="button" class="btn btn-default btn-whatif btn-display" value="whatif">What if</button>
          </div>
        </div>
        <div class=" top-buffer">
          <div id="chart-trump"></div>
          <div id="chart-cruz"></div>
          <div id="chart-rubio"></div>
          <div id="chart-kasich"></div>
        </div>
      </div>
    
    </div> <!-- END OF ROW -->

    <div class="row top-buffer">
      <div class="col-xs-6">
        <h5>The delegates count</h5>
        <div id="stacked"></div>
      </div>
    </div> <!-- END OF ROW -->

    <div class="row top-buffer">
      <div class="col-xs-12">

        <h2>About</h2>
        
       <!--  <p>
        This is a "what if" history: What if every vote accounted for the same ammount of representation? That is what if one vote was equal to one delegate... Would it change the number of delegates allocated to each candidates?
       The SCOTUS affirmed the principle of "One person, One vote" again. But it applies for elections, not primaries. The fact that primaries are managed at the State level and the different types of election of delegates for the nomination (caucus vs. primary, winner-takes-all vs. proportionnal, etc.) kindle very different situations, and some votes matter more than other. Who gets overrepresented? A republican from Utah? A democrat from San Francisco? Which candidate is favored by this disparities?</p>
        <p>I favor a geographical analysis of the nomination process rather than a count of every candidates number of delegates.</p>
        <p>Three scenarios: 1) How it is. 2) If the number of delegates reflected the number of votes. 3) If the</p> 
        + don't take into account the fact that States that vote the first have more influence on the choice of which candidates will continue the race. cf. Jeb Bush.
        + don't take into account the diversity of delegates allocation. Here it is a rough approximation based on 1) States and 2) county population. 
        + suppose that Delegates are allocated statewide and not per congressional district, or counties (like in Texas)-->
      </div>
    
    </div> <!-- END OF ROW -->
  </div> <!-- END OF CONTAINER -->

  <script>
   
  var map_margin = {top: 20, right: 20, bottom: 30, left: 40},
      map_width = 700 - map_margin.left - map_margin.right,
      map_height = 450 - map_margin.top - map_margin.bottom;

  var currentState = 0;
  var currentCandidate = "";
  var currentDisplay = "reality";

  //var repColors = ['#1f78b4', '#33a02c', '#e31a1c', '#ff7f00'];// ColorBrewer
  //var repColors = ['#b2cb06','#e84d0e','#0084ab','#bc2f56'];
  var repColors = ['#403153','#9e7742','#0084ab','#e30513'];
  //var repColorsLight = ['#a6cee3','#b2df8a','#fb9a99','#fdbf6f']; // ColorBrewer lighter
  //var repColorsLight = ['#d4df83','#f49b6a','#69b0cc','#d58692'];
  var repColorsLight = ['#e5dae7','#deba96','#c5d7e9','#f6b89f'];
  var TrumpColors = [repColors[0], repColorsLight[0]];
  var CruzColors = [repColors[1], repColorsLight[1]];
  var RubioColors = [repColors[2], repColorsLight[2]];
  var KasichColors = [repColors[3], repColorsLight[3]];

// MAP //////
  var projection = d3.geo.albersUsa()
    .scale(850)
    .translate([map_width / 2, map_height / 2]);

  var path = d3.geo.path().projection(projection);

  var svg = d3.select("#map").append("svg")
    .attr("width", map_width)
    .attr("height", map_height);

  var opop = d3.scale.linear() // Opacity on population
      .range([0, 1])
      .domain([0, 238216]); // arbitrary value
  var rpop = d3.scale.linear() // Opacity on ratio delegates/voters
      .range([0, 1])
      .domain([0, 2]);

  queue()
      .defer(d3.json, "geo/us.json")
      //.defer(d3.csv, "data/rep.cc.csv")
      .defer(d3.csv, "data/map/counties2.csv")
      .await(ready_counties);

  function ready_counties(error, us, data) {
    if (error) throw error;

    var winnerById = {},
        labelById = {},
        popById = {},
        ratioById = {};

    data.forEach(function(d) {
        winnerById[d.fip] = d.winnerrep;
        labelById[d.fip] = d.label;
        popById[d.fip] = +d.respop72015;
        //ratioById[d.fip] = +d.ratio_county;
        ratioById[d.fip] = +d.ratio_county;
    });
    
    svg.append("path")
      .datum(topojson.feature(us, us.objects.land))
      .attr("d", path)
      .attr("class", "land-boundary");
    
    /*svg.append("path")
        .datum(topojson.feature(us, us.objects.states)) //, function(a, b) { return a !== b; }
        .attr("class", "states")
        .attr("d", path);*/

    svg.append("g")
          .attr("class", "counties")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.counties).features)
      .enter().append("path")
        .attr("class", "county")
        .attr("d", path)
        .style("fill", function(d){
          switch(winnerById[+d.id]) {
            case "D.Trump": return repColors[0];  break;
            case "T.Cruz": return repColors[1]; break;
            case "M.Rubio": return repColors[2]; break;
            case "J.Kasich": return repColors[3]; break;
          }
        })
        .style("fill-opacity", function(d) {
          return rpop(ratioById[+d.id]);
        });

        svg.append("g")
          .attr("class", "states")
        .selectAll("path")
        //.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
        .data(topojson.feature(us, us.objects.states).features)
      .enter().append("path")
        .attr("class", "state")
        .attr("map_state", function(d) {
          return "st"+d.id;
        })
        .attr("d", path)
        .style("fill", function(d){
          switch(winnerById[+d.id]) {
            case "Trump": return repColors[0];  break;
            case "Cruz": return repColors[1]; break;
            case "Rubio": return repColors[2]; break;
            case "Kasich": return repColors[3]; break;
          }
        })
        .on("mouseover", function(d){
          currentState = "st"+d.id;
          highlight_map();
          highlight_chart();
          highlight_stacked();
        });

    svg.append("path")
        .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0); }))
        .attr("d", path)
        .attr("class", "county-boundary");

    // BERTIN MATRIX //
    //Call function to draw the chart
    d3.csv("data/charts/trump.csv", function(data){
      bertin("#chart-trump", data, "Trump", TrumpColors);
    });
    d3.csv("data/charts/cruz.csv", function(data){
      bertin("#chart-cruz", data, "Cruz", CruzColors);
    });
    d3.csv("data/charts/rubio.csv", function(data){
      bertin("#chart-rubio", data, "Rubio", RubioColors);
    });
    d3.csv("data/charts/kasich.csv", function(data){
      bertin("#chart-kasich", data, "Kasich", KasichColors);
    });

    // CUMULATIVE CHARTS //
    d3.json("data/stacked/rep_stacked.json", function(data){
      cumulChart("#stacked", data);
    });
    
  } // function ready_counties()

  // // // // // // // // // // // // // // // // // // // // // // // // // // // 
  // // //  INTERFACE // // // // // // // // // // // // // // // // // // // //
  // // // // // // // // // // // // // // // // // // // // // // // // // // // 
  d3.select(".btn-whatif")
    .on("click", function(){
      
      $(".btn-display[value="+currentDisplay+"]").button("toggle");
      currentDisplay = "whatif";
      $(this).button("toggle");

      d3.csv("data/charts/trump_if.csv", function(data){
        update_bertin(data, "Trump");
      });
      d3.csv("data/charts/cruz_if.csv", function(data){
        update_bertin(data, "Cruz");
      });
      d3.csv("data/charts/rubio_if.csv", function(data){
        update_bertin(data, "Rubio");
      });
      d3.csv("data/charts/kasich_if.csv", function(data){
        update_bertin(data, "Kasich");
      });

       d3.json("data/stacked/rep_stacked_if.json", function(data){
        update_cumulChart(data);
      });

       queue()
        .defer(d3.json, "geo/us.json")
        .defer(d3.csv, "data/map/counties2.csv")
        .await(update_map);
    }); 
  
  d3.select(".btn-reality")
    .on("click", function(){

      $(".btn-display[value="+currentDisplay+"]").button("toggle");
      currentDisplay = "reality";
      $(this).button("toggle");

      d3.csv("data/charts/trump.csv", function(data){
        update_bertin(data, "Trump");
      });
      d3.csv("data/charts/cruz.csv", function(data){
        update_bertin(data, "Cruz");
      });
      d3.csv("data/charts/rubio.csv", function(data){
        update_bertin(data, "Rubio");
      });
      d3.csv("data/charts/kasich.csv", function(data){
        update_bertin(data, "Kasich");
      });

      d3.json("data/stacked/rep_stacked.json", function(data){
        update_cumulChart(data);
      });

      queue()
        .defer(d3.json, "geo/us.json")
        .defer(d3.csv, "data/map/counties2.csv")
        .await(update_map);

    }); 

    function update_map(error, us, data) {
      if (error) throw error;

      var winnerById = {},
          labelById = {},
          popById = {},
          ratioById = {};

      data.forEach(function(d) {
          winnerById[d.fip] = d.winnerrep;
          labelById[d.fip] = d.label;
          popById[d.fip] = +d.respop72015;
          //ratioById[d.fip] = +d.ratio_county;
          ratioById[d.fip] = +d.ratio_county;
      });

      d3.selectAll(".county")
        .data(topojson.feature(us, us.objects.counties).features)
        .transition()
        .duration(300)
        .style("fill-opacity", function(d) {
          if (currentDisplay == "whatif") {
            return opop(popById[+d.id]);
          }
          else {
            return rpop(ratioById[+d.id]);
          }
        });
    }

  /*function ready(error, us, data) {
    if (error) throw error;

    var winnerById = {};

    data.forEach(function(d) {
        winnerById[d.ansi_code] = d.winner;
    });
    
    svg.append("path")
      .datum(topojson.feature(us, us.objects.land))
      .attr("d", path)
      .attr("class", "land-boundary");
    
    svg.append("g")
          .attr("class", "states")
        .selectAll("path")
        //.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
        .data(topojson.feature(us, us.objects.states).features)
      .enter().append("path")
        .attr("class", "state")
        .attr("map_state", function(d) {
          return "st"+d.id;
        })
        .attr("d", path)
        .style("fill", function(d){
          switch(winnerById[+d.id]) {
            case "Trump": return repColors[0];  break;
            case "Cruz": return repColors[1]; break;
            case "Rubio": return repColors[2]; break;
            case "Kasich": return repColors[3]; break;
          }
        })
        .on("mouseover", function(d){
          currentState = "st"+d.id;
          highlight_map();
          highlight_chart();
          highlight_stacked();
        });

    svg.append("path")
        .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0); }))
        .attr("d", path)
        .attr("class", "county-boundary");

    // BERTIN MATRIX //
    //Call function to draw the chart
    d3.csv("data/charts/trump.csv", function(data){
      bertin("#chart-trump", data, "Trump", TrumpColors);
    });
    d3.csv("data/charts/cruz.csv", function(data){
      bertin("#chart-cruz", data, "Cruz", CruzColors);
    });
    d3.csv("data/charts/rubio.csv", function(data){
      bertin("#chart-rubio", data, "Rubio", RubioColors);
    });
    d3.csv("data/charts/kasich.csv", function(data){
      bertin("#chart-kasich", data, "Kasich", KasichColors);
    });

    // CUMULATIVE CHARTS //
    d3.json("data/stacked/rep_stacked.json", function(data){
      cumulChart("#stacked", data);
    });

    
  } // function ready()*/

  function highlight_map() {
    //console.log(currentState);
    d3.selectAll("path.state").style("stroke-width", .3).style("stroke", "#efefef");
    d3.selectAll("[map_state="+(currentState)+"]").style("stroke-width", 1).style("stroke", "#000");
  }

  function highlight_chart() {
    //console.log(currentState);
    d3.selectAll(".bar").style("stroke-width", 0);
    d3.selectAll("[bar_state="+(currentState)+"]").style("stroke-width", 1);
  }

  function highlight_stacked() {
    //console.log(currentState);
    d3.selectAll(".stacked").style("opacity",0.5);
    d3.selectAll("[stacked_state="+(currentState)+"]").style("opacity", 1);
    /*d3.selectAll(".stacked").style("fill", function(d){
          switch(currentCandidate) {
            case "Trump": return repColorsLight[0];  break;
            case "Cruz": return repColorsLight[1]; break;
            case "Rubio": return repColorsLight[2]; break;
            case "Kasich": return repColorsLight[3]; break;
          }
    });
    d3.selectAll("[stacked_state="+(currentState)+"]").style("fill", function(d){
          switch(currentCandidate) {
            case "Trump": return repColors[0];  break;
            case "Cruz": return repColors[1]; break;
            case "Rubio": return repColors[2]; break;
            case "Kasich": return repColors[3]; break;
          }
    });*/
  }

  function highlight_chart_state_name() {
    d3.selectAll(".chart_state_name").style("fill", "#fff");
    d3.selectAll("[chart_state_name="+(currentState)+"]").style("fill", "#aaa");
  }

  </script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="layout/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
</body>
</html>